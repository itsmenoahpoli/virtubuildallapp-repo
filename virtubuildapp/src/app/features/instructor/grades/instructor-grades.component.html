<app-dashboard-layout [appTitle]="appTitle">
  <app-page-shell title="Student Grades" subtitle="View and manage student grades by activity">
    <div class="grades-management">
      <div class="filters-section">
        <div class="filter-group">
          <label for="moduleFilter">Module:</label>
          <select id="moduleFilter" [(ngModel)]="selectedModule" (change)="onModuleChange()">
            <option [value]="null">All Modules</option>
            <option *ngFor="let module of modules" [value]="module.id">{{ module.title }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="activityFilter">Activity:</label>
          <select id="activityFilter" [(ngModel)]="selectedActivity" (change)="onActivityChange()">
            <option [value]="null">Select Activity</option>
            <option *ngFor="let activity of activities" [value]="activity.id">{{ activity.title }}</option>
          </select>
        </div>

        <button class="btn btn-secondary" (click)="refreshGrades()" [disabled]="loading || !selectedActivity">
          <span class="material-icons">refresh</span>
          Refresh
        </button>
      </div>

      <div class="error-message" *ngIf="error">
        <span class="material-icons">error</span>
        {{ error }}
      </div>

      <div class="loading-spinner" *ngIf="loading">
        <span class="material-icons">hourglass_empty</span>
        Loading grades...
      </div>

      <div class="grades-summary" *ngIf="!loading && grades.length > 0">
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-value">{{ grades.length }}</span>
            <span class="stat-label">Total Grades</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getPassRate() }}%</span>
            <span class="stat-label">Pass Rate</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getAverageScore() }}</span>
            <span class="stat-label">Average Score</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getHighestScore() }}</span>
            <span class="stat-label">Highest Score</span>
          </div>
        </div>
      </div>

      <div class="grades-table-container" *ngIf="!loading && grades.length > 0">
        <div class="table-header">
          <h3>Grades for: {{ getActivityName(selectedActivity!) }}</h3>
        </div>
        
        <div class="grades-table">
          <div class="table-header-row">
            <div class="col-student">Student</div>
            <div class="col-email">Email</div>
            <div class="col-score">Score</div>
            <div class="col-status">Status</div>
            <div class="col-date">Date</div>
          </div>
          
          <div class="table-row" *ngFor="let grade of grades; trackBy: trackByGradeId">
            <div class="col-student">
              <div class="student-info">
                <span class="student-name">{{ getStudentName(grade.userId) }}</span>
              </div>
            </div>
            <div class="col-email">
              <span class="student-email">{{ getStudentEmail(grade.userId) }}</span>
            </div>
            <div class="col-score">
              <span class="score-badge" [class]="getGradeClass(grade.score)">
                {{ grade.score }}%
              </span>
            </div>
            <div class="col-status">
              <span class="status-badge" [class]="getGradeClass(grade.score)">
                {{ getGradeStatus(grade.score) }}
              </span>
            </div>
            <div class="col-date">
              <span class="grade-date">{{ formatDate(grade.createdAt || grade.updatedAt) }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="no-grades" *ngIf="!loading && grades.length === 0 && selectedActivity">
        <span class="material-icons">grade</span>
        <h3>No grades found</h3>
        <p>No students have completed this activity yet.</p>
      </div>

      <div class="select-activity" *ngIf="!loading && !selectedActivity">
        <span class="material-icons">assignment</span>
        <h3>Select an Activity</h3>
        <p>Choose an activity from the dropdown above to view student grades.</p>
      </div>
    </div>
  </app-page-shell>
</app-dashboard-layout>


